<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>规则状态切换测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 40px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:hover {
            background: #5568d3;
        }
        button.danger {
            background: #ef4444;
        }
        button.success {
            background: #10b981;
        }
        pre {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 4px;
            overflow: auto;
            max-height: 400px;
            font-size: 12px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        th {
            background: #f9fafb;
            font-weight: 600;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        input:checked + .slider:before {
            transform: translateX(20px);
        }
        .log {
            margin-top: 10px;
            padding: 10px;
            background: #f9fafb;
            border-left: 3px solid #667eea;
            font-size: 12px;
        }
        .log.success {
            border-left-color: #10b981;
            background: #d1fae5;
        }
        .log.error {
            border-left-color: #ef4444;
            background: #fee2e2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>规则状态切换测试</h1>
        
        <div class="section">
            <h2>步骤 1: 加载规则列表</h2>
            <button onclick="loadRules()">加载规则</button>
            <button onclick="readConfig()">读取配置文件</button>
            <div id="rulesOutput"></div>
        </div>

        <div class="section">
            <h2>步骤 2: 测试规则切换</h2>
            <div id="switchTest"></div>
        </div>

        <div class="section">
            <h2>步骤 3: 验证配置文件</h2>
            <button onclick="verifyConfig()">验证配置</button>
            <pre id="configOutput">点击按钮验证...</pre>
        </div>

        <div class="section">
            <h2>操作日志</h2>
            <button onclick="clearLogs()">清空日志</button>
            <div id="logs"></div>
        </div>
    </div>

    <script>
        let rulesData = null;
        let configContent = null;

        function addLog(message, type = 'info') {
            const logs = document.getElementById('logs');
            const log = document.createElement('div');
            log.className = `log ${type}`;
            log.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.insertBefore(log, logs.firstChild);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        async function loadRules() {
            addLog('开始加载规则列表...');
            
            try {
                const response = await fetch('/api/rules');
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                rulesData = data.data || data;
                addLog(`成功加载 ${Object.keys(rulesData).length} 条规则`, 'success');
                
                displayRules();
            } catch (error) {
                addLog(`加载失败: ${error.message}`, 'error');
            }
        }

        function displayRules() {
            const output = document.getElementById('rulesOutput');
            const switchTest = document.getElementById('switchTest');
            
            if (!rulesData) {
                output.innerHTML = '<p>请先加载规则</p>';
                return;
            }

            let html = '<table><thead><tr><th>规则名称</th><th>文件</th><th>当前状态</th><th>操作</th></tr></thead><tbody>';
            
            Object.entries(rulesData).forEach(([key, rule]) => {
                html += `
                    <tr>
                        <td><strong>${rule.name}</strong></td>
                        <td>${rule.file}</td>
                        <td id="status-${key}">${rule.enabled ? '✓ 启用' : '✗ 禁用'}</td>
                        <td>
                            <button class="success" onclick="switchRule('${rule.file}', true)">启用</button>
                            <button class="danger" onclick="switchRule('${rule.file}', false)">禁用</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            output.innerHTML = html;
            
            // 显示开关测试
            switchTest.innerHTML = '<p>选择一个规则进行测试，或使用上面的按钮</p>';
        }

        async function switchRule(file, enabled) {
            const ruleName = file.replace('.lua', '');
            addLog(`正在${enabled ? '启用' : '禁用'}规则: ${file}...`);
            
            try {
                const response = await fetch(`/api/rules/${file}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ enabled })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || `HTTP ${response.status}`);
                }
                
                if (data.data && data.data.success !== false) {
                    addLog(`✓ 规则 ${file} 已${enabled ? '启用' : '禁用'}`, 'success');
                    
                    // 更新显示状态
                    const statusEl = document.getElementById(`status-${ruleName}`);
                    if (statusEl) {
                        statusEl.textContent = enabled ? '✓ 启用' : '✗ 禁用';
                    }
                    
                    // 重新读取配置验证
                    setTimeout(() => verifyConfig(), 500);
                } else {
                    throw new Error('操作失败');
                }
            } catch (error) {
                addLog(`✗ 切换失败: ${error.message}`, 'error');
            }
        }

        async function readConfig() {
            addLog('读取配置文件...');
            
            try {
                const response = await fetch('/api/read-file?file=waf.conf');
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                configContent = data.data?.content || data.data || data.content;
                addLog('配置文件读取成功', 'success');
                
                document.getElementById('configOutput').textContent = configContent;
            } catch (error) {
                addLog(`读取失败: ${error.message}`, 'error');
            }
        }

        async function verifyConfig() {
            addLog('验证配置文件...');
            
            await readConfig();
            
            if (!configContent || !rulesData) {
                addLog('请先加载规则和配置', 'error');
                return;
            }
            
            let output = '配置验证结果:\n\n';
            let allMatch = true;
            
            Object.entries(rulesData).forEach(([key, rule]) => {
                const configKey = `exp_${key}`;
                const pattern = new RegExp(`${configKey}\\s*=\\s*"(on|off)"`, 'i');
                const match = configContent.match(pattern);
                
                if (match) {
                    const configValue = match[1] === 'on';
                    const matches = configValue === rule.enabled;
                    
                    output += `${matches ? '✓' : '✗'} ${configKey}: `;
                    output += `配置=${match[1]}, API=${rule.enabled ? 'on' : 'off'}`;
                    output += matches ? ' (一致)\n' : ' (不一致!)\n';
                    
                    if (!matches) allMatch = false;
                } else {
                    output += `✗ ${configKey}: 未找到配置项\n`;
                    allMatch = false;
                }
            });
            
            output += `\n${allMatch ? '✓ 所有规则状态一致' : '✗ 存在不一致的规则状态'}`;
            
            document.getElementById('configOutput').textContent = output;
            addLog(allMatch ? '验证通过' : '验证发现问题', allMatch ? 'success' : 'error');
        }

        // 页面加载时自动加载规则
        window.addEventListener('load', () => {
            loadRules();
        });
    </script>
</body>
</html>
