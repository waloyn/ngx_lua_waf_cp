<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WAF 日志查看</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="auth.js"></script>
    <style>
        .sidebar {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            z-index: 100;
            padding: 48px 0 0;
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
        }
        .sidebar-sticky {
            position: relative;
            top: 0;
            height: calc(100vh - 48px);
            padding-top: .5rem;
            overflow-x: hidden;
            overflow-y: auto;
        }
        .navbar-brand {
            padding-top: .75rem;
            padding-bottom: .75rem;
        }
        .navbar {
            box-shadow: 0 .125rem .25rem rgba(0, 0, 0, .075);
        }
        .log-container {
            height: calc(100vh - 250px);
            overflow-y: auto;
        }
        .log-entry {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        .log-entry:hover {
            background-color: #f8f9fa;
        }
        .log-time {
            color: #6c757d;
            font-size: 0.875rem;
        }
        .log-level {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        .log-level-info {
            background-color: #cfe2ff;
            color: #084298;
        }
        .log-level-warn {
            background-color: #fff3cd;
            color: #664d03;
        }
        .log-level-error {
            background-color: #f8d7da;
            color: #842029;
        }
    </style>
</head>
<body>
    <header class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
        <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3" href="#">WAF 控制台</a>
        <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="w-100"></div>
        <div class="navbar-nav">
            <div class="nav-item text-nowrap">
                <a class="nav-link px-3" href="#logout">退出</a>
            </div>
        </div>
    </header>

    <div class="container-fluid">
        <div class="row">
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="/dashboard.html">
                                <i class="bi bi-speedometer2"></i> 仪表盘
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/rules.html">
                                <i class="bi bi-shield-check"></i> 规则配置
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/ip-list.html">
                                <i class="bi bi-list-check"></i> 黑白名单
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#">
                                <i class="bi bi-journal-text"></i> 日志查看
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/settings.html">
                                <i class="bi bi-gear"></i> 系统设置
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">日志查看</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-outline-secondary" onclick="exportLogs()">
                                <i class="bi bi-download"></i> 导出日志
                            </button>
                        </div>
                        <button type="button" class="btn btn-outline-primary" onclick="toggleAutoRefresh()" id="refreshBtn">
                            <i class="bi bi-arrow-repeat"></i> 自动刷新
                        </button>
                    </div>
                </div>

                <div class="row g-3 align-items-center mb-3">
                    <div class="col-auto">
                        <input type="date" class="form-select" id="dateSelect" value="">
                    </div>
                    <div class="col-auto">
                        <select class="form-select" id="hostSelect">
                            <option value="www.etggc.com">www.etggc.com</option>
                            <option value="api.etggc.com">api.etggc.com</option>
                            <option value="erp.etggc.com">erp.etggc.com</option>
                            <option value="pos.etggc.com">pos.etggc.com</option>
                            <option value="wechat.etggc.com">wechat.etggc.com</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <select class="form-select" id="logLevel">
                            <option value="all">所有级别</option>
                            <option value="info">正常请求</option>
                            <option value="error">攻击请求</option>
                        </select>
                    </div>
                    <div class="col">
                        <input type="text" class="form-control" id="searchInput" placeholder="搜索日志（IP、请求路径、攻击类型等）...">
                    </div>
                    <div class="col-auto">
                        <button type="button" class="btn btn-primary" onclick="searchLogs()">
                            <i class="bi bi-search"></i> 搜索
                        </button>
                    </div>
                </div>

                <div class="log-container" id="logContainer"></div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let logs = [];
        let autoRefreshInterval = null;
        let isAutoRefreshEnabled = false;

        // 渲染日志
        function renderLogs() {
            const container = document.getElementById('logContainer');
            const level = document.getElementById('logLevel').value;
            const search = document.getElementById('searchInput').value.toLowerCase();

            const filteredLogs = logs.filter(log => {
                const matchLevel = level === 'all' || log.level === level;
                const matchSearch = !search || 
                    log.message.toLowerCase().includes(search) || 
                    log.ip.toLowerCase().includes(search);
                return matchLevel && matchSearch;
            });

            container.innerHTML = filteredLogs.map(log => `
                <div class="log-entry">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="log-time">${log.time}</span>
                        <span class="log-level log-level-${log.level}">${log.level === 'error' ? '攻击请求' : '正常请求'}</span>
                    </div>
                    <div class="mt-1">
                        <strong>请求ID:</strong> ${log.request_id}
                        <strong class="ms-3">IP:</strong> ${log.ip}
                    </div>
                    <div class="mt-1">
                        <strong>${log.method}</strong> ${log.path}
                    </div>
                    <div class="mt-1">
                        <strong>User Agent:</strong> <small class="text-muted">${log.user_agent}</small>
                    </div>
                    <div class="mt-1 ${log.level === 'error' ? 'text-danger' : ''}"><strong>拦截规则:</strong> ${log.message}</div>
                </div>
            `).join('');

            // 如果开启了自动刷新，滚动到底部
            if (isAutoRefreshEnabled) {
                container.scrollTop = container.scrollHeight;
            }
        }

        // 搜索日志
        function searchLogs() {
            renderLogs();
        }

        // 获取日志数据
        async function fetchLogs() {
            try {
                const dateInput = document.getElementById('dateSelect');
                const date = dateInput.value || new Date().toISOString().split('T')[0];
                const host = document.getElementById('hostSelect')?.value || 'default';
                const response = await fetch(`/api/logs?host=${host}&date=${date}`);
                const data = await response.json();
                
                if (data.code === 200 && data.data) {
                    // 解析每条日志记录
                    const newLogs = data.data
                        .map(logStr => {
                            const log = JSON.parse(logStr);
                            return {
                                time: log.request_time,
                                level: log.attack_type ? 'error' : 'info',
                                ip: log.ip,
                                path: log.request_uri,
                                message: log.attack_type || '正常请求',
                                request_id: log.request_id,
                                method: log.http_method,
                                protocol: log.request_protocol,
                                user_agent: log.user_agent
                            };
                        });
                    
                    // 更新日志数组
                    logs = newLogs;
                    renderLogs();
                }
            } catch (error) {
                console.error('获取日志失败:', error);
            }
        }

        // 切换自动刷新
        function toggleAutoRefresh() {
            const btn = document.getElementById('refreshBtn');
            isAutoRefreshEnabled = !isAutoRefreshEnabled;

            if (isAutoRefreshEnabled) {
                btn.classList.remove('btn-outline-primary');
                btn.classList.add('btn-primary');
                autoRefreshInterval = setInterval(fetchLogs, 2000);
            } else {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline-primary');
                clearInterval(autoRefreshInterval);
            }
        }

        // 导出日志
        function exportLogs() {
            const level = document.getElementById('logLevel').value;
            const search = document.getElementById('searchInput').value.toLowerCase();

            const filteredLogs = logs.filter(log => {
                const matchLevel = level === 'all' || log.level === level;
                const matchSearch = !search || 
                    log.message.toLowerCase().includes(search) || 
                    log.ip.toLowerCase().includes(search);
                return matchLevel && matchSearch;
            });

            const blob = new Blob([JSON.stringify(filteredLogs, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `waf-logs-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // 监听搜索框输入和选择变化
        document.getElementById('searchInput').addEventListener('input', renderLogs);
        document.getElementById('logLevel').addEventListener('change', renderLogs);
        document.getElementById('hostSelect').addEventListener('change', () => {
            logs = [];
            fetchLogs();
        });

        // 初始化页面
        document.addEventListener('DOMContentLoaded', () => {
            fetchLogs();
        });
    </script>
</body>
</html>