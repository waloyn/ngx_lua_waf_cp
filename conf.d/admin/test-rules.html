<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>规则加载测试</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #f5f5f5;
        }
        .section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
        }
        pre {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 4px;
            overflow: auto;
            max-height: 600px;
        }
        .success { color: green; }
        .error { color: red; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        th {
            background: #f9fafb;
            font-weight: 600;
        }
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .badge-high { background: #fee2e2; color: #dc2626; }
        .badge-medium { background: #fef3c7; color: #d97706; }
        .badge-low { background: #dbeafe; color: #2563eb; }
    </style>
</head>
<body>
    <h1>规则加载测试</h1>
    
    <div class="section">
        <h2>步骤 1: 测试 API 响应</h2>
        <button onclick="testAPI()">测试 /api/rules</button>
        <pre id="apiOutput">点击按钮测试...</pre>
    </div>

    <div class="section">
        <h2>步骤 2: 解析规则数据</h2>
        <button onclick="parseRules()">解析规则</button>
        <div id="rulesOutput"></div>
    </div>

    <div class="section">
        <h2>步骤 3: 渲染规则表格</h2>
        <button onclick="renderTable()">渲染表格</button>
        <div id="tableOutput"></div>
    </div>

    <script>
        let rulesData = null;

        async function testAPI() {
            const output = document.getElementById('apiOutput');
            output.textContent = '正在请求...\n';
            
            try {
                const response = await fetch('/api/rules');
                const data = await response.json();
                
                output.textContent = `状态码: ${response.status}\n\n`;
                output.textContent += `响应数据:\n${JSON.stringify(data, null, 2)}`;
                output.className = response.ok ? 'success' : 'error';
                
                if (response.ok) {
                    rulesData = data.data || data;
                    output.textContent += '\n\n✓ API 响应正常，数据已保存';
                }
            } catch (error) {
                output.textContent = `错误: ${error.message}`;
                output.className = 'error';
            }
        }

        function parseRules() {
            const output = document.getElementById('rulesOutput');
            
            if (!rulesData) {
                output.innerHTML = '<p class="error">请先测试 API 获取数据</p>';
                return;
            }

            try {
                output.innerHTML = '<h3>数据类型检查</h3>';
                output.innerHTML += `<p>数据类型: ${typeof rulesData}</p>`;
                output.innerHTML += `<p>是否为对象: ${typeof rulesData === 'object'}</p>`;
                output.innerHTML += `<p>是否为数组: ${Array.isArray(rulesData)}</p>`;
                output.innerHTML += `<p>键数量: ${Object.keys(rulesData).length}</p>`;
                
                output.innerHTML += '<h3>规则列表</h3>';
                output.innerHTML += '<pre>' + JSON.stringify(rulesData, null, 2) + '</pre>';
                
                output.innerHTML += '<h3>转换为数组</h3>';
                const rules = Object.entries(rulesData).map(([key, rule]) => ({
                    key: key,
                    file: rule.file,
                    name: rule.name,
                    desc: rule.desc,
                    level: rule.level || 'medium',
                    position: rule.position || 'uri,body',
                    enabled: rule.enabled !== false
                }));
                
                output.innerHTML += `<p class="success">✓ 成功转换为数组，共 ${rules.length} 条规则</p>`;
                output.innerHTML += '<pre>' + JSON.stringify(rules, null, 2) + '</pre>';
                
                window.parsedRules = rules;
            } catch (error) {
                output.innerHTML = `<p class="error">解析失败: ${error.message}</p>`;
                console.error(error);
            }
        }

        function renderTable() {
            const output = document.getElementById('tableOutput');
            
            if (!window.parsedRules) {
                output.innerHTML = '<p class="error">请先解析规则数据</p>';
                return;
            }

            try {
                const rules = window.parsedRules;
                
                let html = `
                    <p class="success">✓ 准备渲染 ${rules.length} 条规则</p>
                    <table>
                        <thead>
                            <tr>
                                <th>规则名称</th>
                                <th>描述</th>
                                <th>危险等级</th>
                                <th>检测位置</th>
                                <th>状态</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                rules.forEach(rule => {
                    const levelClass = 
                        rule.level === 'high' ? 'badge-high' : 
                        rule.level === 'medium' ? 'badge-medium' : 
                        'badge-low';
                    
                    html += `
                        <tr>
                            <td><strong>${rule.name}</strong></td>
                            <td>${rule.desc || '-'}</td>
                            <td><span class="badge ${levelClass}">${rule.level}</span></td>
                            <td>${rule.position || '-'}</td>
                            <td>${rule.enabled ? '✓ 启用' : '✗ 禁用'}</td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
                
                output.innerHTML = html;
            } catch (error) {
                output.innerHTML = `<p class="error">渲染失败: ${error.message}</p>`;
                console.error(error);
            }
        }

        // 页面加载时自动测试
        window.addEventListener('load', () => {
            testAPI();
        });
    </script>
</body>
</html>
