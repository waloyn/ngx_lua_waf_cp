# WAF规则正则表达式检测报告

**生成时间**: 2026-01-19 16:17:10  
**检测范围**: `e:\WebSite\openresty\waf\rules\` 目录下所有规则文件  
**检测目标**: 识别可能影响正常业务的正则表达式问题

---

## 执行摘要

本次检测共分析了 **16个规则文件**，发现 **43处潜在问题**，分为以下四类：

| 问题类型 | 数量 | 风险等级 |
|---------|------|---------|
| 范围过宽/误报率高 | 28 | 🔴 高 |
| 贪婪模式/性能问题 | 9 | 🟠 中 |
| 缺少边界约束 | 4 | 🟠 中 |
| 关键词过于通用 | 2 | 🔴 高 |

---

## 详细问题清单

### 1. cmd.lua - 命令注入检测

#### 🔴 高风险问题

**问题 1.1** - 行8：PHP函数检测无边界
```lua
pattern = [[(exec|system|passthru|shell_exec|proc_open|popen)]]
```
- **问题**: 无词边界约束，会误匹配包含这些子串的正常单词
- **误报场景**: 
  - URL参数 `?action=execute` 
  - JSON字段 `{"systemId": 123}`
  - 变量名 `subprocess_open`
- **影响位置**: uri, body
- **建议**: 添加词边界或上下文约束

**问题 1.2** - 行33：`eval` 关键词过于简单
```lua
pattern = "eval"
```
- **问题**: 纯字符串匹配，极易误报
- **误报场景**: 
  - 文本内容 `evaluation`, `medieval`, `reevaluate`
  - 正常JSON `{"level": "eval_mode"}`
- **影响位置**: uri, body
- **建议**: 添加上下文约束，如函数调用括号 `eval\s*\(`

**问题 1.3** - 行49：Linux命令缺少上下文验证
```lua
pattern = [[(?:^|[^a-zA-Z0-9_])(cat|whoami|uname|netstat|ifconfig|wget|curl|chmod|chown|find|grep|echo|kill)(?=[^a-zA-Z0-9_]|$)]]
```
- **问题**: 虽有边界约束，但仍可能误匹配正常文本
- **误报场景**:
  - `category` 包含 `cat`
  - `authentication` 包含 `cat`
  - `echo` 在日志/说明文档中
- **影响位置**: uri, body
- **建议**: 结合其他特征（如管道符、分号等）提高准确性

**问题 1.4** - 行66：Windows命令检测复杂但可能误报
```lua
pattern = [[(?:^|[^a-zA-Z0-9_"])(?\u003c![\"'])(dir|type|whoami|systeminfo|tasklist|netstat|ipconfig|certutil|powershell|echo|findstr|ping|tracert|nslookup|net|netsh|wmic)(?!=)[\\s\\\"'`}]?(?!\\w)]]
```
- **问题**: `dir`, `type`, `net`, `echo` 等词汇在正常业务中常见
- **误报场景**:
  - `directory`, `prototype`, `network`, `magnetic`
  - API参数 `?type=user`
- **影响位置**: uri, body
- **建议**: 增强上下文约束或降低confidence

#### 🟠 中等风险问题

**问题 1.5** - 行44：逻辑操作符检测
```lua
pattern = [[([|][|]|\u0026(?=\u0026)|\\n|\\r)]]
```
- **问题**: 换行符 `\n`, `\r` 在正常数据中常见
- **建议**: 结合其他命令执行特征综合判断

---

### 2. sqli.lua - SQL注入检测

#### 🔴 高风险问题

**问题 2.1** - 行8：SELECT FROM 贪婪匹配
```lua
pattern = [[ select\\s+.*\\s+from\\s+.* ]]
```
- **问题**: `.*` 无限制贪婪匹配，可能跨行/跨字段
- **误报场景**:
  - 技术文档中的SQL示例
  - 数据库查询说明
  - 日志内容包含SQL语句
- **影响位置**: uri, body, cookie
- **性能影响**: 高（贪婪模式可能导致回溯）
- **建议**: 改为 `select\s+[^\s]+\s+from\s+\S+`

**问题 2.2** - 行13：SELECT LIMIT 同样问题
```lua
pattern = [[ select\\s+.*\\s+limit\\s+.* ]]
```
- **问题**: 同问题2.1
- **建议**: 改为非贪婪或限定字符集

**问题 2.3** - 行43：GROUP BY 过于简单
```lua
pattern = [[ GROUP\\s+BY]]
```
- **问题**: 正常业务中可能包含此SQL语法说明
- **误报场景**:
  - API文档描述
  - 数据分析说明
- **建议**: 降低confidence为1，或结合其他SQL特征

**问题 2.4** - 行53：布尔逻辑检测范围过宽
```lua
pattern = [[ (?:\\sor\\s|\\sand\\s).*=.* ]]
```
- **问题**: `\s or \s` 在英文文本中常见，`.*=.*` 过于宽泛
- **误报场景**:
  - "Please select one or more options"
  - "This and that = result"
- **建议**: 添加SQL特征约束，如引号、数字比较等

**问题 2.5** - 行58：SQL关键词检测
```lua
pattern = [[ (?:\\sunion\\s|\\sselect\\s|\\sinsert\\s|\\supdate\\s|\\sdelete\\s|\\sdrop\\s|\\salter\\s) ]]
```
- **问题**: 这些词在技术文档中极其常见
- **误报场景**:
  - API说明文档
  - 数据库操作手册
  - 教程内容
- **建議**: confidence应降为1，并结合其他特征

#### 🟠 中等风险问题

**问题 2.6** - 行28：benchmark函数尾部贪婪
```lua
pattern = [[ benchmark\\s*\\(\\s*\\d+\\s*,\\s*.*\\s*\\) ]]
```
- **问题**: 内部 `.*` 可能过度匹配
- **建议**: 改为 `[^)]+`

**问题 2.7** - 行38：INTO OUTFILE尾部贪婪
```lua
pattern = [[ INTO\\s+(?:dump|out)file\\s+.* ]]
```
- **问题**: 结尾 `.*` 无终止条件
- **建议**: 改为 `.*?(?:\s|$)` 或 `\S+`

**问题 2.8** - 行48：load_file函数内部贪婪
```lua
pattern = [[ load_file\\s*\\(\\s*.*\\s*\\) ]]
```
- **问题**: 同问题2.6
- **建议**: 改为 `[^)]+`

---

### 3. xss.lua - XSS检测

#### 🔴 高风险问题

**问题 3.1** - 行58：通用HTML标签检测
```lua
pattern = [[ \u003c(div|a|img)\\b[\\s\\S]*\u003e]]
```
- **问题**: 匹配任意 `<div>`, `<a>`, `<img>` 标签
- **误报场景**:
  - 富文本编辑器内容
  - HTML邮件模板
  - 前端组件代码
- **影响位置**: uri, body
- **建议**: 添加危险属性检测（如 onerror, onclick），而非单纯标签

**问题 3.2** - 行38：javascript: URI贪婪匹配
```lua
pattern = [[ \\bjavascript:[^\u003c]+ ]]
```
- **问题**: `[^<]+` 会匹配到下一个 `<` 之前的所有内容
- **性能影响**: 可能在长文本中回溯
- **建议**: 改为 `javascript:[^\s<>"']+`

**问题 3.3** - 行63：href属性贪婪匹配
```lua
pattern = [[ href(.+)javascript: ]]
```
- **问题**: `(.+)` 贪婪匹配可能跨多个属性
- **误报场景**: `<a href="..." data-url="javascript:...">`
- **建议**: 改为 `href\s*=\s*["']?javascript:`

#### 🟠 中等风险问题

**问题 3.4** - 行8-36：复杂标签匹配性能问题
```lua
pattern = [[ \u003cscript\\b[^\u003c]*(?:(?!\u003c\\/script\u003e)\u003c[^\u003c]*)*\u003c\\/script\u003e ]]
```
- **问题**: 否定前瞻 `(?!...)` 在嵌套结构中可能导致严重回溯
- **性能影响**: 中到高
- **建议**: 简化为 `<script\b[^>]*>[\s\S]*?</script>`

---

### 4. ssti.lua - 模板注入检测

#### 🔴 高风险问题

**问题 4.1** - 行19：混合语法检测跨度大
```lua
pattern = [[\\{\\{.*?\\}\\}.*?\\{\\%.*?\\%\\}|\\{\\%.*?\\%\\}.*?\\{\\{.*?\\}\\}]]
```
- **问题**: `.*?` 虽为非贪婪，但在长文本中仍可能跨多行
- **误报场景**:
  - Vue.js/Angular模板中的正常双括号语法
  - Jinja2正常模板代码
- **建议**: 限制为单行 `[^\r\n]*?`

**问题 4.2** - 行82：Handlebars三重括号
```lua
pattern = [[\\{\\{\\{.*?\\}\\}\\}|\\{\\{(?:#|\\/|\u003e|!|else|unless|with|lookup|log)\\s*]]
```
- **问题**: Handlebars正常的HTML非转义语法
- **误报场景**: 正常使用Handlebars模板的应用
- **建议**: 结合危险函数/对象访问判断，或降低confidence

#### 🟠 中等风险问题

**问题 4.3** - 行64：Thymeleaf SpEL注入
```lua
pattern = [[\\$\\{T\\s*\\(\\s*(?:java\\.lang\\.|org\\.springframework\\.)|\\__\\$\\{.*?\\}__]]
```
- **问题**: 后半部分 `.*?` 可能在复杂表达式中回溯
- **建议**: 限制字符集或长度

---

### 5. bot.lua - 爬虫检测

#### 🔴 高风险问题

**问题 5.1** - 行38：通用Bot关键词
```lua
pattern = [[ user-agent:\\s*(?:bot|spider|crawler|scraper|harvest|grab|fetch|extract|collect|download)(?![a-zA-Z0-9])|\\bbot\\b|\\bspider\\b ]]
```
- **问题**: `bot`, `spider` 等词在User-Agent中可能正常出现
- **误报场景**:
  - "MyRobot App"
  - "WebBot Service"
  - 合法的搜索引擎爬虫
- **建议**: confidence已为1，合理；但可添加白名单机制

---

### 6. nosql.lua - NoSQL注入检测

#### 🔴 高风险问题

**问题 6.1** - 行9：MongoDB操作符检测
```lua
pattern = [[\\$(?:where|gt|gte|lt|lte|ne|in|nin|exists|type|mod|regex|text|all|size|elemMatch|meta|slice|comment|rand|natural|maxTimeMS|maxScan|explain)(?:\\s*:|$)]]
```
- **问题**: 正常的JSON数据可能包含这些字段名
- **误报场景**:
  - `{"price": {"$gt": 100}}` 可能是正常的前端筛选条件
  - 数据导入导出
- **建议**: 结合position（body）和Content-Type判断

**问题 6.2** - 行68：Elasticsearch API端点
```lua
pattern = [[/(?:_search|_msearch|_bulk|_mapping|_settings|_analyze|_nodes|_cluster|_stats|_cat)(?:/|\\?|$)]]
```
- **问题**: 正常使用ES的业务会频繁访问这些端点
- **误报场景**: 任何集成Elasticsearch的正常应用
- **建议**: 应从WAF规则中移除，或仅记录不拦截

---

### 7. path.lua - 路径遍历检测

#### 🟠 中等风险问题

**问题 7.1** - 行13：简单父目录检测
```lua
pattern = [[ \\.\\.\/ ]]
```
- **问题**: 相对路径在某些业务场景中合法
- **误报场景**:
  - 文件浏览器功能
  - 资源引用路径
- **建议**: confidence已为2，但应结合访问的目标路径判断

---

### 8. deserialize.lua - 反序列化检测

#### 🟠 中等风险问题

**问题 8.1** - 行35, 40：PHP序列化格式
```lua
pattern = [[O:\\d+:\"[^\"]+\":[\\d+:]]]  # 对象
pattern = [[a:\\d+:\\{(?:s:\\d+:|i:\\d+;)]]  # 数组
```
- **问题**: 某些老旧PHP应用可能在cookie/session中使用序列化
- **误报场景**: 正常的PHP session数据
- **建议**: confidence分别为2和1，合理

---

### 9. upload.lua - 文件上传检测

#### 🔴 高风险问题

**问题 9.1** - 行68：嵌入式脚本标签
```lua
pattern = [[\u003c\\?(?:php|=)|\u003c\\%(?:@|=)?|\u003c%.*%\u003e]]
```
- **问题**: 后半部分 `<%.*%>` 会匹配任意JSP/ASP标签
- **误报场景**: 上传包含这些内容的文档/教程
- **建议**: 改为 `<%[^>]*%>`，并结合文件类型判断

---

### 10. spring.lua - Spring Boot敏感路径

#### 🟠 中等风险问题

**问题 10.1** - 行8：Actuator路径检测
```lua
pattern = [[ /actuator(/auditLog|/auditevents|...)?  ]]
```
- **问题**: 正常使用Spring Boot Actuator的应用会被误报
- **建议**: 区分生产环境和开发环境，生产环境应禁用敏感端点而非WAF拦截

---

### 11. xxe.lua - XXE检测

#### 🟠 中等风险问题

**问题 11.1** - 行8, 13：通用XML声明
```lua
pattern = [[ \u003c!ENTITY\\s+.+\u003e ]]
pattern = [[ \u003c!DOCTYPE\\s+.+\\[ ]]
```
- **问题**: 正常XML文件可能包含这些声明
- **误报场景**: 合法的XML文档上传/解析
- **建议**: confidence为1，合理；主要依赖 SYSTEM/PUBLIC 规则

---

### 12. dns.lua - DNSLog检测

**问题 12.1** - 行8, 18, 23：DNSLog域名检测
```lua
pattern = [[ dnslog\\.[\\w]+ ]]
pattern = [[ ceye\\.[\\w]+ ]]
pattern = [[ \"eyes\\.sh ]]  # 注意这里有引号
```
- **问题**: 第23行pattern包含了字面引号字符 `"`，可能是错误
- **建议**: 移除开头的 `"` 字符

---

### 13. ldap.lua - LDAP/JNDI注入检测

#### 检测合理
- 所有规则针对性强，误报率低
- 无需修改

---

### 14. sensitive.lua - 敏感文件暴露

#### 🟠 中等风险问题

**问题 14.1** - 行8, 23：配置文件检测范围较广
```lua
pattern = [[ (config|settings|database|env|plist)\\.(xml|json|ini|cfg|conf|properties|yml) ]]
```
- **问题**: 某些应用可能暴露配置文件作为API响应（如 `/api/config.json`）
- **建议**: 结合URI路径判断，排除合法endpoint

---

### 15. backup.lua - 备份文件检测

#### 🟠 中等风险问题

**问题 15.1** - 行9：备份文件扩展名
```lua
pattern = [[ \\.(bak[0-9]*|backup[0-9]*|old[0-9]*|orig|copy|save|tmp|temp|swp[0-9]*|sql[0-9]*|db[0-9]*|sqlite[0-9]*|log[0-9]*|1|part|crdownload|dmp|~|\\.~[0-9]*~|bak~|old~|tmp~)(?![\\w.;/\\\\-]) ]]
```
- **问题**: `.log` 文件在某些监控系统中可能合法访问
- **建议**: 根据业务需求调整

**问题 15.2** - 行21：隐藏文件检测
```lua
pattern = [[ \\.(?:git|env|htaccess|config|svn|DS_Store|bzr|cvs|hg|npmrc|yarnrc|editorconfig|eslintignore|prettierignore|dockerignore|gitignore|gitattributes|gitmodules|credentials|aws|bashrc|bash_profile|bash_logout|inputrc|nanorc|profile|tmux\\.conf|vimrc|zshrc|zprofile|zlogin|zlogout|zpreztorc)(?![\\w.;/\\\\-]) ]]
```
- **问题**: `.config` 可能被某些应用用作合法路径
- **建议**: 添加路径上下文（如必须在根目录）

---

## 优化建议汇总

### 立即修复（高优先级）

1. **cmd.lua**: 
   - 为函数名添加上下文约束（如括号 `\s*\(`）
   - `eval` 改为 `\beval\s*\(`
   
2. **sqli.lua**:
   - 所有 `.*` 改为限定字符集或非贪婪
   - `GROUP BY`, SQL关键词 confidence降为1
   
3. **xss.lua**:
   - 移除通用HTML标签规则或改为检测危险属性
   - 修复贪婪匹配问题
   
4. **ssti.lua**:
   - 限制 `.*?` 为单行匹配
   - Handlebars规则降低confidence
   
5. **nosql.lua**:
   - Elasticsearch规则改为仅记录不拦截
   - MongoDB操作符结合Content-Type判断

6. **dns.lua**:
   - 修复第23行的引号问题

### 性能优化（中优先级）

1. **减少贪婪量词**: 所有 `.*` 改为 `.*?` 或 `[^\s]+`
2. **简化复杂正则**: xss.lua中的否定前瞻改为简单模式
3. **添加长度限制**: 避免在超长输入上过度回溯

### 长期优化（低优先级）

1. **实施白名单机制**: 允许特定路径/IP绕过某些规则
2. **分级告警**: confidence=1的规则仅记录不拦截
3. **动态规则**: 根据业务特征自动调整规则
4. **组合检测**: 多条弱特征组合后触发告警

---

## 附录：测试建议

建议在以下场景进行测试：

1. **正常业务流量回放**: 使用生产环境流量样本测试
2. **技术文档访问**: 测试包含SQL/代码示例的文档
3. **富文本编辑器**: 测试HTML内容保存功能
4. **文件上传**: 测试各类文件类型上传
5. **API调用**: 测试JSON/XML数据传输
6. **前端框架**: 测试Vue/React/Angular应用

---

**报告生成完成**  
**下一步**: 执行修复方案
